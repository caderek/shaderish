(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}})();const ae=["solid","gradient","noise","circle","plasma","singularity","rainbow","liquid","warp","accretion","phosphor","waves"];function ie(e){document.querySelector("footer").innerHTML="<p>"+ae.map(t=>`<a href="/?shader=${t}&res=${e.get("res")??"640x360"}&tile=${e.get("tile")??"8x8"}">${t}</a>`).join(" | ")+"</p><p>"+["1920x1080","1280x720","640x360","320x180","160x90"].map(t=>`<a href="/?shader=${e.get("shader")??"singularity"}&res=${t}&tile=${e.get("tile")??"8x8"}">${t}p</a>`).join(" | ")+"</p><p>"+["1x1","2x2","4x4","8x8","16x16","32x32","64x64","2x1","4x2","8x4","16x8","32x16","64x32"].map(t=>`<a href="/?shader=${e.get("shader")??"singularity"}&res=${e.get("res")??"640x360"}&tile=${t}">${t}</a>`).join(" | ")+"</p>"}function W(e,t=1){return e/t*2-1}function ce(e,t,s,r,o,n,a){const f=o*n,u=t[3],T=t[4],F=new Uint32Array(e.buffer,0),[R,S,C,$,b]=s;for(;;){const p=Atomics.add(t,0,1);if(p>=f)return;const m=p*a/4,U=m+a/4,E=p%o,te=Math.trunc(p/o);for(let z=m,X=0;z<U;z++,X++){const oe=X%u+E*u,ne=Math.trunc(X/u)+te*T,re=Math.fround((oe+.5)/(S/2)-1),se=Math.fround(1-(ne+.5)/(C/2));F[z]=r(re,se,R,S,C,$,b)}}}function le(e,t,s,r,o){const a=e.length/4,f=s*r,T=a/f/o,F=new Uint32Array(e.buffer,e.byteOffset,a),R=new Uint32Array(t.buffer,t.byteOffset,t.length/4),S=o*s;let C=0;for(let $=0;$<T;$++)for(let b=0;b<o;b++){const p=$*r*S+b*s;for(let m=0;m<r;m++){const U=p+m*S;for(let E=0;E<s;E++)R[U+E]=F[C++]}}}document.querySelector("footer").textContent="v0.0.1";const h={tileCounter:0,workersDone:1,workersCount:2,tileSizeX:3,tileSizeY:4},M=new URLSearchParams(location.search);ie(M);const[i,l]=(M.get("res")??"640x360").split("x").map(Number),de=M.get("shader")??"plasma",[g,x]=(M.get("tile")??"8x8").split("x").map(Number),Z=await ge(de),fe=1/0,ue=Math.floor(window.innerWidth/320),pe=320*ue,me=pe/i,w=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});w.width=i;w.height=l;w.style.setProperty("--width",i);w.style.setProperty("--scale",me);w.style.setProperty("--ratio",`${i} / ${l}`);const he=document.getElementById("fps"),ye=w.getContext("2d");async function ge(e){const t=await fetch(`/shaders/${e}.js`).then(r=>r.blob()),s=new File([t],"shader.js",{type:"application/javascript"});return URL.createObjectURL(s)}const xe=i*l*4,G=g*x*4,O=Math.ceil(i/g),k=Math.ceil(l/x),I=O*k,d=G*I,L=0,v=64,D=64,B=d+L+v+L+D,A=crossOriginIsolated?new SharedArrayBuffer(B):new ArrayBuffer(B),_=new Uint8ClampedArray(A,0,d),y=new Int32Array(A,d+L,v/4),P=new Float32Array(A,d+v+L*2,D/4),J=crossOriginIsolated?new Uint8ClampedArray(d):_,we=new ImageData(J.subarray(0,xe),i,l);let Y=0,K=0,j=0,N=0;window.addEventListener("mousemove",e=>{j=W(e.clientX,1920),N=W(e.clientY,1080)});const Se=navigator.hardwareConcurrency??4,c=Math.min(crossOriginIsolated?Se:0,fe),$e=Math.ceil(I/c);console.log({crossOriginIsolated});console.log({threads:c>0?c:1});console.table({w:i,h:l,tileSizeX:g,tileSizeY:x,tilesPerRow:O,tilesPerCol:k,tilesCount:I,tileByteSize:G,tilesPerWorker:$e,framebufferSize:d,controlbufferSize:v,vramSize:B});console.log(A);const Q=Array.from({length:c},()=>new Worker(new URL("/assets/run-E5tyEd7v.js",import.meta.url),{type:"module"}));let q=0,H=0,be=null,V=null,Ee=new Promise(e=>{V=e});const Pe=(await import(Z)).fragment;Q.forEach(e=>{e.addEventListener("message",t=>{switch(t.data){case"rendered":{q++,q===c&&be();break}case"loaded":{H++,H===c&&V();break}}}),e.postMessage(["init",A,d,v,D,L,O,k]),e.postMessage(["loadShader",Z])});y[h.workersCount]=c;y[h.tileSizeX]=g;y[h.tileSizeY]=x;async function ee(e=0){c>0&&await Ee;const t=performance.now();P[0]=e/1e3,P[1]=i,P[2]=l,P[3]=j,P[4]=N,c>0?(Q.forEach((r,o)=>r.postMessage(["runShader"])),await Atomics.waitAsync(y,h.workersDone,0).value,q=0,y[h.tileCounter]=0,y[h.workersDone]=0):ce(_,Pe,{t:e/1e3,w:i,h:l,mouseX:j,mouseY:N},0,I);const s=performance.now();if(le(_,J,g,x,O),ye.putImageData(we,0,0),Y%10===0){const r=performance.now(),o=s-t,n=r-s,a=o+n,f=e-K,u=f>0?1e3/f:0;he.innerText=`FPS: ${u.toFixed(1)}, All: ${a.toFixed(2).padStart(5,"0")}ms, Shader: ${o.toFixed(2).padStart(5,"0")}ms, Clone: ${n.toFixed(2).padStart(5,"0")}ms, Threads: ${c??1}, Res: ${i}x${l}px, Tile: ${g}x${x}`,Y=0}K=e,Y++,requestAnimationFrame(ee)}ee();
