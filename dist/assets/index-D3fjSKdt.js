(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function s(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(t){if(t.ep)return;t.ep=!0;const r=s(t);fetch(t.href,r)}})();function j(e,n=1){return e/n*2-1}const S=8;function ee(e,n,s,o,t,r,l){const d=new Float32Array(4),$=t*r;for(;;){const m=Atomics.add(n,0,1);if(m>=$)return;const g=m*l,w=g+l,K=m%t,G=Math.trunc(m/t);for(let f=g,v=0;f<w;f+=4,v++){const H=v%S+K*S,J=Math.trunc(v/S)+G*S,Q=Math.fround((H+.5)/(s[1]/2)-1),V=Math.fround(1-(J+.5)/(s[2]/2));o(d,Q,V,s),e[f]=d[0]*255,e[f+1]=d[1]*255,e[f+2]=d[2]*255,e[f+3]=d[3]*255}}}const L=8,te=4;function oe(e,n,s){const o=L*te;for(let t=0;t<e.length/o;t++){const r=Math.floor(t/L),l=r%s,d=Math.floor(r/s),$=t%L,g=(d*L+$)*s+l,w=t*o;n.set(e.subarray(w,w+o),g*o)}}document.querySelector("footer").textContent="v0.0.1";const b={tileCounter:0,workersDone:1,workersCount:2},re=["solid","gradient","dirtytiles","circle","plasma","singularity","rainbow","liquid","warp","accretion","phosphor"],ne=Number(new URLSearchParams(location.search).get("factor")??"1"),se=new URLSearchParams(location.search).get("shader")??"plasma",z=await ue(se);document.querySelector("footer").innerHTML="<p>"+re.map(e=>`<a href="/?shader=${e}&factor=${new URLSearchParams(location.search).get("factor")??"1"}">${e}</a>`).join(" | ")+"</p><p>"+[1,2,4,8].map(e=>`<a href="/?shader=${new URLSearchParams(location.search).get("shader")??"singularity"}&factor=${e}">1 / ${e}</a>`).join(" | ")+"</p>";const ae=1/0,E=8,B=e=>e/ne,ce=320*4/devicePixelRatio,a=B(640),i=B(360),ie=ce/a,h=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});h.width=a;h.height=i;h.style.setProperty("--width",a);h.style.setProperty("--scale",ie);h.style.setProperty("--ratio",`${a} / ${i}`);const le=document.getElementById("fps"),de=h.getContext("2d");async function ue(e){const n=await fetch(`/shaders/${e}.js`).then(o=>o.blob()),s=new File([n],"shader.js",{type:"application/javascript"});return URL.createObjectURL(s)}const fe=a*i*4,N=E**2*4,O=Math.ceil(a/E),U=Math.ceil(i/E),R=O*U,u=N*R,p=64,T=64,C=u+p+T,y=crossOriginIsolated?new SharedArrayBuffer(C):new ArrayBuffer(C),F=new Uint8ClampedArray(y,0,u),I=new Int32Array(y,u,p/4),P=new Float32Array(y,u+p,T/4),X=crossOriginIsolated?new Uint8ClampedArray(u):F,he=new ImageData(X.subarray(0,fe),a,i);let A=0,Y=0,_=0,D=0;window.addEventListener("mousemove",e=>{_=j(e.clientX,1920),D=j(e.clientY,1080)});const me=navigator.hardwareConcurrency??4,c=Math.min(crossOriginIsolated?me:0,ae),M=Math.ceil(R/c);console.log({crossOriginIsolated});console.log({threads:c>0?c:1});console.table({w:a,h:i,tileSize:E,tilesPerRow:O,tilesPerCol:U,tilesCount:R,tileByteSize:N,tilesPerWorker:M,framebufferSize:u,controlbufferSize:p,vramSize:C});console.log(y);const k=Array.from({length:c},()=>new Worker(new URL("/assets/run-BGFD2FRl.js",import.meta.url),{type:"module"}));let x=0,q=0,pe=null,W=null,ye=new Promise(e=>{W=e});const ge=(await import(z)).fragment;k.forEach(e=>{e.addEventListener("message",n=>{switch(n.data){case"rendered":{x++,x===c&&pe();break}case"loaded":{q++,q===c&&W();break}}}),e.postMessage(["init",y,u,p,T,O,U]),e.postMessage(["loadShader",z])});I[b.workersCount]=c;async function Z(e=0){c>0&&await ye;const n=performance.now();if(P[0]=e/1e3,P[1]=a,P[2]=i,c>0?(k.forEach((s,o)=>s.postMessage(["runShader",[[o*M,o*M+M]]])),await Atomics.waitAsync(I,b.workersDone,0).value,x=0,I[b.tileCounter]=0,I[b.workersDone]=0):ee(F,ge,{t:e/1e3,w:a,h:i,mouseX:_,mouseY:D},0,R),A%10===0){const s=performance.now()-n,o=e-Y,t=o>0?1e3/o:0;le.innerText=`FPS: ${t.toFixed(1)}, Render: ${s.toFixed(2)}ms, Threads: ${c??1}, Res: ${a}x${i}px`,A=0}Y=e,A++,oe(F,X,O),de.putImageData(he,0,0),requestAnimationFrame(Z)}Z();
