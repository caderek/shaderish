(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();function U(e,r=1){return e/r*2-1}const g=8;function k(e,r,s,o,t,n,l){const d=new Float32Array(4),v=t*n;for(;;){const p=Atomics.add(r,0,1);if(p>=v)return;const m=p*l,y=m+l,{w:W,h:Z}=o,K=p%t,H=Math.trunc(p/t);for(let u=m,O=0;u<y;u+=4,O++){const G=O%g+K*g,J=Math.trunc(O/g)+H*g,Q=Math.fround((G+.5)/(W/2)-1),V=Math.fround(1-(J+.5)/(Z/2));s(d,Q,V,o),e[u]=d[0]*255,e[u+1]=d[1]*255,e[u+2]=d[2]*255,e[u+3]=d[3]*255}}}const w=8,ee=4;function te(e,r,s){const o=w*ee;for(let t=0;t<e.length/o;t++){const n=Math.floor(t/w),l=n%s,d=Math.floor(n/s),v=t%w,m=(d*w+v)*s+l,y=t*o;r.set(e.subarray(y,y+o),m*o)}}document.querySelector("footer").textContent="v0.0.1";const oe=["solid","dirtytiles","circle","plasma","singularity","rainbow","warp","accretion","phospor"],ne=Number(new URLSearchParams(location.search).get("factor")??"1"),re=new URLSearchParams(location.search).get("shader")??"solid",j=await de(re);document.querySelector("footer").innerHTML="<p>"+oe.map(e=>`<a href="/?shader=${e}">${e}</a>`).join(" | ")+"</p><p>"+[1,2,4,8].map(e=>`<a href="/?factor=${e}">1 / ${e}</a>`).join(" | ")+"</p>";const se=1/0,b=8,T=e=>e*ne,ae=640*2/devicePixelRatio,a=T(640),c=T(360),ce=ae/a,f=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});f.width=a;f.height=c;f.style.setProperty("--width",a);f.style.setProperty("--scale",ce);f.style.setProperty("--ratio",`${a} / ${c}`);const ie=document.getElementById("fps"),le=f.getContext("2d");async function de(e){const r=await fetch(`/shaders/${e}.js`).then(o=>o.blob()),s=new File([r],"shader.js",{type:"application/javascript"});return URL.createObjectURL(s)}const ue=a*c*4,Y=b**2*4,L=Math.ceil(a/b),R=Math.ceil(c/b),M=L*R,h=Y*M,I=64,$=h+I,E=crossOriginIsolated?new SharedArrayBuffer($):new ArrayBuffer($),x=new Uint8ClampedArray(E,0,h),fe=new Uint32Array(E,h,I/4),q=crossOriginIsolated?new Uint8ClampedArray(h):x,he=new ImageData(q.subarray(0,ue),a,c);let P=0,C=0,X=0,_=0;window.addEventListener("mousemove",e=>{X=U(e.clientX,1920),_=U(e.clientY,1080)});const pe=navigator.hardwareConcurrency??4,i=Math.min(crossOriginIsolated?pe:0,se),S=Math.ceil(M/i);console.log({crossOriginIsolated});console.log({threads:i>0?i:1});console.table({w:a,h:c,tileSize:b,tilesPerRow:L,tilesPerCol:R,tilesCount:M,tileByteSize:Y,tilesPerWorker:S,framebufferSize:h,controlbufferSize:I,vramSize:$});console.log(E);const z=Array.from({length:i},()=>new Worker(new URL("/assets/run-B_AuqDU4.js",import.meta.url),{type:"module"}));let A=0,F=0,B=null,N=null,me=new Promise(e=>{N=e});const ye=(await import(j)).fragment;z.forEach(e=>{e.addEventListener("message",r=>{switch(r.data){case"rendered":{A++,A===i&&B();break}case"loaded":{F++,F===i&&N();break}}}),e.postMessage(["init",E,h,I,L,R]),e.postMessage(["loadShader",j])});async function D(e=0){i>0&&await me;const r=performance.now();let s;if(i>0?(s=new Promise(o=>{B=o}),z.forEach((o,t)=>o.postMessage(["runShader",{t:e/1e3,w:a,h:c},[[t*S,t*S+S]]])),await s,A=0,fe[0]=0):k(x,ye,{t:e/1e3,w:a,h:c,mouseX:X,mouseY:_},0,M),P%10===0){const o=performance.now()-r,t=e-C,n=t>0?1e3/t:0;ie.innerText=`FPS: ${n.toFixed(1)}, Render: ${o.toFixed(2)}ms, Threads: ${i??1}, Res: ${a}x${c}px`,P=0}C=e,P++,te(x,q,L),le.putImageData(he,0,0),requestAnimationFrame(D)}D();
