(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();const oe=["solid","gradient","noise","circle","plasma","plasma-fast","singularity","rainbow","liquid","warp","accretion","phosphor","waves"];function ne(e){document.querySelector("footer").innerHTML="<p>"+oe.map(t=>`<a href="/?shader=${t}&res=${e.get("res")??"640x360"}&tile=${e.get("tile")??"8x8"}">${t}</a>`).join(" | ")+"</p><p>"+["1920x1080","1280x720","640x360","320x180","160x90","480x480","240x240","512x512","256x256","128x128"].map(t=>`<a href="/?shader=${e.get("shader")??"singularity"}&res=${t}&tile=${e.get("tile")??"8x8"}">${t}p</a>`).join(" | ")+"</p><p>"+["1x1","2x2","4x4","8x8","16x16","32x32","64x64","2x1","4x2","8x4","16x8","32x16","64x32"].map(t=>`<a href="/?shader=${e.get("shader")??"singularity"}&res=${e.get("res")??"640x360"}&tile=${t}">${t}</a>`).join(" | ")+"</p>"}function D(e,t=1){return e/t*2-1}function se(e,t,o,s,r,n,i){const u=r*n,p=t[3],I=t[4],M=new Uint32Array(e.buffer,0),T=new ArrayBuffer(16),m=new Float32Array(T,0,4),U=o[0],$=new Float32Array([o[1],o[2]]),A=new Float32Array([o[3],o[4]]);for(;;){const h=Atomics.add(t,0,1);if(h>=u)return;const y=h*i/4,R=y+i/4,b=h%r,re=Math.trunc(h/r);for(let z=y,B=0;z<R;z++,B++)m[0]=B%p+b*p+.5,m[1]=Math.trunc(B/p)+re*I+.5,M[z]=s(m,$,U,A)}}function ae(e,t,o,s,r){const i=e.length/4,u=o*s,I=i/u/r,M=new Uint32Array(e.buffer,e.byteOffset,i),T=new Uint32Array(t.buffer,t.byteOffset,t.length/4),m=r*o;let U=0;for(let $=0;$<I;$++)for(let A=0;A<r;A++){const h=$*s*m+A*o;for(let y=0;y<s;y++){const R=h+y*m;for(let b=0;b<o;b++)T[R+b]=M[U++]}}}document.querySelector("footer").textContent="v0.0.1";const x={tileCounter:0,workersDone:1,workersCount:2,tileSizeX:3,tileSizeY:4},C=new URLSearchParams(location.search);ne(C);const[a,l]=(C.get("res")??"640x360").split("x").map(Number),ie=C.get("shader")??"plasma",[w,S]=(C.get("tile")??"8x8").split("x").map(Number),H=await me(ie),j={play:!0},ce=8,le=Math.floor(window.innerWidth/a),de=a*le,fe=de/a,d=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});d.width=a;d.height=l;d.style.setProperty("--width",a);d.style.setProperty("--scale",fe);d.style.setProperty("--ratio",`${a} / ${l}`);const ue=document.getElementById("fps"),pe=d.getContext("2d");async function me(e){const t=await fetch(`/shaders/${e}.js`).then(s=>s.blob()),o=new File([t],"shader.js",{type:"application/javascript"});return URL.createObjectURL(o)}const he=a*l*4,V=w*S*4,O=Math.ceil(a/w),k=Math.ceil(l/S),F=O*k,f=V*F,L=0,P=64,q=64,N=f+L+P+L+q,v=crossOriginIsolated?new SharedArrayBuffer(N):new ArrayBuffer(N),X=new Uint8ClampedArray(v,0,f),g=new Int32Array(v,f+L,P/4),E=new Float32Array(v,f+P+L*2,q/4),Z=crossOriginIsolated?new Uint8ClampedArray(f):X,ye=new ImageData(Z.subarray(0,he),a,l);let _=0,W=0,G=0,J=0;window.addEventListener("mousemove",e=>{G=D(e.clientX,1920),J=D(e.clientY,1080)});const xe=navigator.hardwareConcurrency??4,c=Math.min(crossOriginIsolated?xe:0,ce),ge=Math.ceil(F/c);console.log({crossOriginIsolated});console.log({threads:c>0?c:1});console.table({w:a,h:l,tileSizeX:w,tileSizeY:S,tilesPerRow:O,tilesPerCol:k,tilesCount:F,tileByteSize:V,tilesPerWorker:ge,framebufferSize:f,controlbufferSize:P,vramSize:N});console.log(v);const Q=Array.from({length:c},()=>new Worker(new URL("/assets/run-DzUVD4xK.js",import.meta.url),{type:"module"}));let Y=0,K=0,we=null,ee=null,Se=new Promise(e=>{ee=e});const $e=c===0?(await import(H)).fragment:null;Q.forEach(e=>{e.addEventListener("message",t=>{switch(t.data){case"rendered":{Y++,Y===c&&we();break}case"loaded":{K++,K===c&&ee();break}}}),e.postMessage(["init",v,f,P,q,L,O,k]),e.postMessage(["loadShader",H])});g[x.workersCount]=c;g[x.tileSizeX]=w;g[x.tileSizeY]=S;async function te(e=0){if(j.play){c>0&&await Se;const t=performance.now();E[0]=e/1e3,E[1]=a,E[2]=l,E[3]=G,E[4]=J,c>0?(Q.forEach((s,r)=>s.postMessage(["runShader"])),await Atomics.waitAsync(g,x.workersDone,0).value,Y=0,g[x.tileCounter]=0,g[x.workersDone]=0):se(X,$e,{},0,F);const o=performance.now();if(ae(X,Z,w,S,O),pe.putImageData(ye,0,0),_%10===0){const s=performance.now(),r=o-t,n=s-o,i=r+n,u=e-W,p=u>0?1e3/u:0;ue.innerText=`FPS: ${p.toFixed(1)}, All: ${i.toFixed(2).padStart(5,"0")}ms, Shader: ${r.toFixed(2).padStart(5,"0")}ms, Clone: ${n.toFixed(2).padStart(5,"0")}ms, Threads: ${c??1}, Res: ${a}x${l}px, Tile: ${w}x${S}`,_=0}W=e,_++}requestAnimationFrame(te)}d.addEventListener("click",()=>{j.play=!j.play});te();
