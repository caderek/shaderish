(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();function j(e,r=1){return e/r*2-1}const m=8;function k(e,r,n,s,t){const{w:o,h:c}=n,y=Math.ceil(o/m);for(let f=s;f<t;f++){const g=f%y*m,R=Math.trunc(f/y)*m;for(let d=R;d<R+m&&d<c;d++){const w=d*o;for(let p=g;p<g+m&&p<o;p++){const S=(w+p)*4,K=Math.fround((p+.5)/(o/2)-1),H=Math.fround(1-(d+.5)/(c/2)),L=r(K,H,n);e[S]=L[0]*255,e[S+1]=L[1]*255,e[S+2]=L[2]*255,e[S+3]=L[3]*255}}}}const b=8,G=4;function J(e,r,n,s){const t=b*G;for(let o=0;o<e.length/t;o++){const c=Math.floor(o/b),y=c%n,f=Math.floor(c/n),g=o%b,d=(f*b+g)*n+y,w=o*t;r.set(e.subarray(w,w+t),d*t)}}document.querySelector("footer").textContent="v0.0.1";const Q=["circle","plasma","singularity","rainbow","warp","accretion","phospor"],V=Number(new URLSearchParams(location.search).get("factor")??"1"),ee=new URLSearchParams(location.search).get("shader")??"plasma",T=await ae(ee);document.querySelector("footer").innerHTML="<p>"+Q.map(e=>`<a href="/?shader=${e}">${e}</a>`).join(" | ")+"</p><p>"+[1,2,4,8].map(e=>`<a href="/?factor=${e}">1 / ${e}</a>`).join(" | ")+"</p>";const te=1/0,I=8,X=e=>e/V,oe=640*2/devicePixelRatio,a=X(640),i=X(360),re=oe/a,u=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});u.width=a;u.height=i;u.style.setProperty("--width",a);u.style.setProperty("--scale",re);u.style.setProperty("--ratio",`${a} / ${i}`);const ne=document.getElementById("fps"),se=u.getContext("2d");async function ae(e){const r=await fetch(`/shaders/${e}.js`).then(s=>s.blob()),n=new File([r],"shader.js",{type:"application/javascript"});return URL.createObjectURL(n)}const ce=a*i*4,q=I**2*4,M=Math.ceil(a/I),U=Math.ceil(i/I),v=M*U,h=q*v,E=64,x=h+E,O=crossOriginIsolated?new SharedArrayBuffer(x):new ArrayBuffer(x),C=new Uint8ClampedArray(O,0,h),ie=new Uint32Array(O,h,E/4),z=crossOriginIsolated?new Uint8ClampedArray(h):C,le=new ImageData(z.subarray(0,ce),a,i);let $=0,F=0,N=0,_=0;window.addEventListener("mousemove",e=>{N=j(e.clientX,1920),_=j(e.clientY,1080)});const de=navigator.hardwareConcurrency??4,l=Math.min(crossOriginIsolated?de:0,te),P=Math.ceil(v/l);console.log({crossOriginIsolated});console.log({threads:l>0?l:1});console.table({w:a,h:i,tileSize:I,tilesPerRow:M,tilesPerCol:U,tilesCount:v,tileByteSize:q,tilesPerWorker:P,framebufferSize:h,controlbufferSize:E,vramSize:x});console.log(O);const B=Array.from({length:l},()=>new Worker(new URL("/assets/run-CL-bfvoL.js",import.meta.url),{type:"module"}));let A=0,Y=0,W=null,Z=null,fe=new Promise(e=>{Z=e});const ue=(await import(T)).fragment;B.forEach(e=>{e.addEventListener("message",r=>{switch(r.data){case"rendered":{A++,A===l&&W();break}case"loaded":{Y++,Y===l&&Z();break}}}),e.postMessage(["init",O,h,E,M,U]),e.postMessage(["loadShader",T])});async function D(e=0){l>0&&await fe;const r=performance.now();let n;if(l>0?(n=new Promise(s=>{W=s}),B.forEach((s,t)=>s.postMessage(["runShader",{t:e/1e3,w:a,h:i},[[t*P,t*P+P]]])),await n,A=0,ie[0]=0):k(C,ue,{t:e/1e3,w:a,h:i,mouseX:N,mouseY:_},0,v),$%10===0){const s=performance.now()-r,t=e-F,o=t>0?1e3/t:0;ne.innerText=`FPS: ${o.toFixed(1)}, Render: ${s.toFixed(2)}ms, Threads: ${l??1}, Res: ${a}x${i}px`,$=0}F=e,$++,J(C,z,M),se.putImageData(le,0,0),requestAnimationFrame(D)}D();
