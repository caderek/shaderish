(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(t){if(t.ep)return;t.ep=!0;const o=s(t);fetch(t.href,o)}})();function j(e,r=1){return e/r*2-1}function te(e,r,s,n,t,o,a){const u=new Float32Array(4),L=t*o,x=r[3],A=r[4];for(;;){const S=Atomics.add(r,0,1);if(S>=L)return;const M=S*a,O=M+a,J=S%t,Q=Math.trunc(S/t);for(let p=M,z=0;p<O;p+=4,z++){const Z=z%x+J*x,G=Math.trunc(z/x)+Q*A,V=Math.fround((Z+.5)/(s[1]/2)-1),ee=Math.fround(1-(G+.5)/(s[2]/2));n(u,V,ee,s),e[p]=u[0]*255,e[p+1]=u[1]*255,e[p+2]=u[2]*255,e[p+3]=u[3]*255}}}const oe=4;function re(e,r,s,n,t){const o=s*oe;for(let a=0;a<e.length/o;a++){const u=Math.floor(a/n),L=u%t,x=Math.floor(u/t),A=a%n,M=(x*n+A)*t+L,O=a*o;r.set(e.subarray(O,O+o),M*o)}}document.querySelector("footer").textContent="v0.0.1";const h={tileCounter:0,workersDone:1,workersCount:2,tileSizeX:3,tileSizeY:4},ne=["solid","gradient","dirtytiles","circle","plasma","singularity","rainbow","liquid","warp","accretion","phosphor"],l=new URLSearchParams(location.search),se=Number(l.get("factor")??"1"),ae=l.get("shader")??"plasma",[g,y]=(l.get("tile")??"8x8").split("x").map(Number),U=await fe(ae);document.querySelector("footer").innerHTML="<p>"+ne.map(e=>`<a href="/?shader=${e}&factor=${l.get("factor")??"1"}&tile=${l.get("tile")??"8x8"}">${e}</a>`).join(" | ")+"</p><p>"+[1,2,4,8].map(e=>`<a href="/?shader=${l.get("shader")??"singularity"}&factor=${e}&tile=${l.get("tile")??"8x8"}">1 / ${e}</a>`).join(" | ")+"</p><p>"+["1x1","2x2","4x4","8x8","16x16","32x32","64x64","1x2","2x4","4x8","8x16","16x32","32x64"].map(e=>`<a href="/?shader=${l.get("shader")??"singularity"}&factor=${l.get("factor")??1}&tile=${e}">${e}</a>`).join(" | ")+"</p>";const ce=4,q=e=>e/se,ie=320*4/devicePixelRatio,c=q(640),d=q(360),le=ie/c,w=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});w.width=c;w.height=d;w.style.setProperty("--width",c);w.style.setProperty("--scale",le);w.style.setProperty("--ratio",`${c} / ${d}`);const de=document.getElementById("fps"),ue=w.getContext("2d");async function fe(e){const r=await fetch(`/shaders/${e}.js`).then(n=>n.blob()),s=new File([r],"shader.js",{type:"application/javascript"});return URL.createObjectURL(s)}const pe=c*d*4,B=g*y*4,v=Math.ceil(c/g),X=Math.ceil(d/y),C=v*X,f=B*C,$=64,Y=64,I=f+$+Y,b=crossOriginIsolated?new SharedArrayBuffer(I):new ArrayBuffer(I),P=new Uint8ClampedArray(b,0,f),m=new Int32Array(b,f,$/4),E=new Float32Array(b,f+$,Y/4),D=crossOriginIsolated?new Uint8ClampedArray(f):P,he=new ImageData(D.subarray(0,pe),c,d);let F=0,N=0,_=0,k=0;window.addEventListener("mousemove",e=>{_=j(e.clientX,1920),k=j(e.clientY,1080)});const me=navigator.hardwareConcurrency??4,i=Math.min(crossOriginIsolated?me:0,ce),ge=Math.ceil(C/i);console.log({crossOriginIsolated});console.log({threads:i>0?i:1});console.table({w:c,h:d,tileSizeX:g,tileSizeY:y,tilesPerRow:v,tilesPerCol:X,tilesCount:C,tileByteSize:B,tilesPerWorker:ge,framebufferSize:f,controlbufferSize:$,vramSize:I});console.log(b);const W=Array.from({length:i},()=>new Worker(new URL("/assets/run-Cc-JQ6c-.js",import.meta.url),{type:"module"}));let R=0,T=0,ye=null,K=null,we=new Promise(e=>{K=e});const xe=(await import(U)).fragment;W.forEach(e=>{e.addEventListener("message",r=>{switch(r.data){case"rendered":{R++,R===i&&ye();break}case"loaded":{T++,T===i&&K();break}}}),e.postMessage(["init",b,f,$,Y,v,X]),e.postMessage(["loadShader",U])});m[h.workersCount]=i;m[h.tileSizeX]=g;m[h.tileSizeY]=y;async function H(e=0){i>0&&await we;const r=performance.now();if(E[0]=e/1e3,E[1]=c,E[2]=d,i>0?(W.forEach((s,n)=>s.postMessage(["runShader"])),await Atomics.waitAsync(m,h.workersDone,0).value,R=0,m[h.tileCounter]=0,m[h.workersDone]=0):te(P,xe,{t:e/1e3,w:c,h:d,mouseX:_,mouseY:k},0,C),F%10===0){const s=performance.now()-r,n=e-N,t=n>0?1e3/n:0;de.innerText=`FPS: ${t.toFixed(1)}, Render: ${s.toFixed(2)}ms, Threads: ${i??1}, Res: ${c}x${d}px, Tile: ${g}x${y}`,F=0}N=e,F++,re(P,D,g,y,v),ue.putImageData(he,0,0),requestAnimationFrame(H)}H();
