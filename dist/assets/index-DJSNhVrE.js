(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function r(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=r(t);fetch(t.href,o)}})();function Y(e,n=1){return e/n*2-1}const m=8;function k(e,n,r,s,t){const{w:o,h:a}=r,y=Math.ceil(o/m);for(let f=s;f<t;f++){const g=f%y*m,R=Math.trunc(f/y)*m;for(let d=R;d<R+m&&d<a;d++){const w=d*o;for(let p=g;p<g+m&&p<o;p++){const S=(w+p)*4,K=Math.fround((p+.5)/(o/2)-1),H=Math.fround(1-(d+.5)/(a/2)),L=n(K,H,r);e[S]=L[0]*255,e[S+1]=L[1]*255,e[S+2]=L[2]*255,e[S+3]=L[3]*255}}}}const b=8,G=4;function J(e,n,r,s){const t=b*G;for(let o=0;o<e.length/t;o++){const a=Math.floor(o/b),y=a%r,f=Math.floor(a/r),g=o%b,d=(f*b+g)*r+y,w=o*t;n.set(e.subarray(w,w+t),d*t)}}document.querySelector("footer").textContent="v0.0.1";const Q=1/0,M=8,T=e=>e/1,V=640*2/devicePixelRatio,c=T(640),i=T(360),ee=V/c,te=["circle","plasma","singularity","rainbow","warp","accretion","phospor"];document.querySelector("footer").innerHTML=te.map(e=>`<a href="/?shader=${e}">${e}</a>`).join(" | ");const oe=new URLSearchParams(location.search).get("shader")??"plasma",X=await se(oe),u=document.querySelector("canvas",{alpha:!1,willReadFrequently:!1});u.width=c;u.height=i;u.style.setProperty("--width",c);u.style.setProperty("--scale",ee);u.style.setProperty("--ratio",`${c} / ${i}`);const ne=document.getElementById("fps"),re=u.getContext("2d");async function se(e){const n=await fetch(`/shaders/${e}.js`).then(s=>s.blob()),r=new File([n],"shader.js",{type:"application/javascript"});return URL.createObjectURL(r)}const ce=c*i*4,q=M**2*4,P=Math.ceil(c/M),U=Math.ceil(i/M),v=P*U,h=q*v,E=64,$=h+E,O=crossOriginIsolated?new SharedArrayBuffer($):new ArrayBuffer($),C=new Uint8ClampedArray(O,0,h),ae=new Uint32Array(O,h,E/4),z=crossOriginIsolated?new Uint8ClampedArray(h):C,ie=new ImageData(z.subarray(0,ce),c,i);let x=0,j=0,_=0,B=0;window.addEventListener("mousemove",e=>{_=Y(e.clientX,1920),B=Y(e.clientY,1080)});const le=navigator.hardwareConcurrency??4,l=Math.min(crossOriginIsolated?le:0,Q),I=Math.ceil(v/l);console.log({crossOriginIsolated});console.log({threads:l>0?l:1});console.table({w:c,h:i,tileSize:M,tilesPerRow:P,tilesPerCol:U,tilesCount:v,tileByteSize:q,tilesPerWorker:I,framebufferSize:h,controlbufferSize:E,vramSize:$});console.log(O);const N=Array.from({length:l},()=>new Worker(new URL("/assets/run-CL-bfvoL.js",import.meta.url),{type:"module"}));let A=0,F=0,W=null,Z=null,de=new Promise(e=>{Z=e});const fe=(await import(X)).fragment;N.forEach(e=>{e.addEventListener("message",n=>{switch(n.data){case"rendered":{A++,A===l&&W();break}case"loaded":{F++,F===l&&Z();break}}}),e.postMessage(["init",O,h,E,P,U]),e.postMessage(["loadShader",X])});async function D(e=0){l>0&&await de;const n=performance.now();let r;if(l>0?(r=new Promise(s=>{W=s}),N.forEach((s,t)=>s.postMessage(["runShader",{t:e/1e3,w:c,h:i},[[t*I,t*I+I]]])),await r,A=0,ae[0]=0):k(C,fe,{t:e/1e3,w:c,h:i,mouseX:_,mouseY:B},0,v),x%10===0){const s=performance.now()-n,t=e-j,o=t>0?1e3/t:0;ne.innerText=`FPS: ${o.toFixed(1)}, Render: ${s.toFixed(2)}ms, Threads: ${l??1}, Res: ${c}x${i}px`,x=0}j=e,x++,J(C,z,P),re.putImageData(ie,0,0),requestAnimationFrame(D)}D();
